<!DOCTYPE html>
<head>
	<meta charset="utf-8">

	<style>
		[ng-click]{
			cursor: pointer;
		}

		path {
			stroke: #fff;
			fill-rule: evenodd;
		}
		/* For modern browsers */
		.clearfix:before,
		.clearfix:after {
				content:"";
				display:table;
		}
		.folder{
			background: gainsboro;
		}
		.clearfix:after {
				clear:both;
		}
		/* For IE 6/7 (trigger hasLayout) */
		.clearfix {
				zoom:1;
		}

		svg{
			float: left;
		}
		ul{
			float: right;
			width: 700px;
		}
		ul span {
			float: right;
		}
		article, aside, figure, footer, header, hgroup,
		menu, nav, section { display: block; }

		#breadcrumb a{
			display: inline-block;
			background: white;
			padding: 5px;
			margin: 0;
			float: left;
			border: 1px solid black;
			position: relative;
			padding-right: 19px;
			padding-left: 24px;
			text-decoration: none;
		}
		#breadcrumb a:hover:after,
		#breadcrumb a:hover{
			background: gray;
		}
		#breadcrumb a:after{
			content: "";
			display: inline-block;
			background: white;
			height: 20px;
			width: 20px;
			position: absolute;
			top: 4px;
			-webkit-transform: rotate(45deg);
			-moz-transform: rotate(45deg);
			-ms-transform: rotate(45deg);
			-o-transform: rotate(45deg);
			transform: rotate(45deg);
			z-index: 1;
			border: 1px solid black;
			border-width: 1px 1px 0px 0px;
			right: -11px;
		}
		a:hover{
			color:red;
		}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.11/angular.min.js"></script>
	<script src="http://d3js.org/d3.v3.min.js"></script>

</head>
<body ng-app="wis">

	<input id="input" type="file" webkitDirectory>

	<div ng-controller="ListCtrl as list">

		<nav class="clearfix" id="breadcrumb">
			<a ng-repeat="item in list.path(list.data)" ng-click="list.click(item)">
				<!-- <span ng-if="$index==0">{{item.path}}</span> -->
				<span>{{item.name}}</span>
			</a>
		</nav>

		<ul><li
			ng-repeat="item in list.data.children"
			ng-class="{folder: !!item.children}"
			ng-click="list.click(item)"
			title="{{item.path}}"
			>{{item.name}} <span>{{item.value | filesize}}</span></li></ul>

	</div><!-- List controll -->


	<script>
	var app = angular.module("wis", []);

	// Returns human friendly file size
	app.filter('filesize', function () {
		return function (size) {
			if (size >= 1073741824) return Math.round(size / 1073741824, 1) + " GB";
			if (size >= 1048576) return Math.round(size / 1048576, 1) + " MB";
			if (size >= 1024) return Math.round(size / 1024, 1) + " KB";
			return size + " b";
		};
	});

	function ListCtrl($scope) {
		var List = this;

		// Returns the path by travling upwords from the current node
		List.path = function (root) {
			if (!root) return [];

			var path = [];
			var depth = root;

			do {
				path.unshift(depth);
			} while (depth = depth.parent);

			return path;
		};

		// Animate the transition in/out from cirkle
		List.click = function (d) {
			List.svg.transition()
				.duration(750)
				.attrTween("d", arcTween(d));

			List.data = d;
		}

		// Read all the entries -> create a hierarchy -> preview
		input.onchange = function () {
			var files = input.files,
				i = 0,
				len = files.length,
				json = [];

			for (; i < len; i++) {
				json.push({
					path: files[i].webkitRelativePath,
					name: files[i].name,
					size: files[i].name == "." ? 0 : files[i].size,
					type: files[i].type
				});
			}

			// clear cache
			input.value = "";
			files = null;

			preview(toHierarchy(json));
			$scope.$apply(); // Let angular know that stuff has changed
		};

		// turns a array into this: https://github.com/mbostock/d3/wiki/Hierarchy-Layout#wiki-children
		// Might be an esier way to do it with d3.nest() if you have any idea how, please tell me
		function toHierarchy(entries) {
			var x = 0,
				tree = {};

			for (; x < entries.length; x++) {
				var current = null,
					entry = entries[x],
					existing = null,
					steps = entry.path.split("/"),
					i = 0;

				steps.pop();

				for (var y = 0; y < steps.length; y++) {
					if (y == 0) {
						if (!tree.children || typeof tree.children == 'undefined') {
							tree = { name: steps[y], children: [] };
						}
						current = tree.children;
					} else {
						existing = null;
						for (i = 0; i < current.length; i++) {
							if (current[i].name === steps[y]) {
								existing = current[i];
								break;
							}
						}
						if (existing) {
							current = existing.children;
						} else {
							current.push({
								name: steps[y],
								children: []
							});
							current = current[current.length - 1].children;
						}
					}
				}
				current.push(entry)
			}

			return tree;
		};


		var width = 700,
			height = 700,
			radius = Math.min(width, height) / 2;

		var x = d3.scale.linear()
			.range([0, 2 * Math.PI]);

		var y = d3.scale.sqrt()
			.range([0, radius]);

		var color = d3.scale.category20c();

		var svg = d3.select("body").append("svg")
			.attr("width", width)
			.attr("height", height)
			.append("g")
			.attr("transform", "translate(" + width / 2 + "," + (height / 2 + 10) + ")");

		var partition = d3.layout.partition()
			.value(function (d) { return d.size; });

		var arc = d3.svg.arc()
			.startAngle(function (d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x))); })
			.endAngle(function (d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx))); })
			.innerRadius(function (d) { return Math.max(0, y(d.y)); })
			.outerRadius(function (d) { return Math.max(0, y(d.y + d.dy)); });

		function preview(root) {
			List.svg = svg.selectAll("path")
				.data(partition.nodes(root))
				.enter().append("path")
				.attr("d", arc)
				.style("fill", function (d) { return color((d.children ? d : d.parent).name); })
				.on("click", function (d) {
					List.click(d);
					$scope.$apply(); // Let angular know it
				});


			List.data = root;
		};



		d3.select(self.frameElement).style("height", height + "px");

		// Interpolate the scales!
		function arcTween(d) {
			var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
				yd = d3.interpolate(y.domain(), [d.y, 1]),
				yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
			return function (d, i) {
				return i ? function (t) {
					return arc(d);
				} : function (t) {
					x.domain(xd(t));
					y.domain(yd(t)).range(yr(t));
					return arc(d);
				};
			};
		}

	}
	</script>
